<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../bower_components/polymer/lib/utils/import-href.html">

<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/iron-lazy-pages/iron-lazy-pages.html">
<dom-module id="realm-app">
  <template>
    <app-localstorage-document key="session" data="{{session}}">
    </app-localstorage-document>
    <iron-lazy-pages selected="[[page]]"
                     attr-for-selected="data-route">
                       <template is="iron-lazy-page" data-route="web" path="realm-web.html">
                            <realm-web></realm-web>
                       </template>
                       <template is="iron-lazy-page" data-route="dashboard" path="realm-dashboard.html">
                            <realm-dashboard></realm-dashboard>
                       </template>
                     </iron-lazy-pages>
  </template>

  <script>

    class RealmApp extends Polymer.Element {

      static get is() {
        return 'realm-app';
      }

      static get properties() {
        return {
          session: {
            type: Object,
            value: null,
            observer: '_onSessionChanged'
          },
          page: {
            type: String,
            value: 'web'
          }
        };
      }

      constructor() {
        super();
        window.performance && performance.mark && performance.mark('realm-app.created');
      }

      ready() {
        super.ready();
        console.log('Realm App is ready!');
        this.removeAttribute('unresolved');
        this._ensureLazyLoaded();
      }
      _onSessionChanged(session) {
        console.log(session);
        if (session) {
          this.set('page', 'dashboard');
        } else {
          this.set('page', 'web');
        }
      }
      _ensureLazyLoaded() {
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
              }
              this.loadComplete = true;
            });
          });
        }
      }
    }

    customElements.define(RealmApp.is, RealmApp);

  </script>

</dom-module>
