<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../bower_components/polymer/lib/utils/import-href.html">

<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/lazy-imports/lazy-imports.html">

<dom-module id="realm-app">
  <link rel="lazy-import" group="web" href="realm-web.html">
  <link rel="lazy-import" group="dashboard" href="realm-dashboard.html">
  <template>
    <app-localstorage-document key="session" data="{{session}}">
    </app-localstorage-document>
    <iron-pages selected="[[page]]"
                     attr-for-selected="data-route">
                      <realm-web data-route="web"></realm-web>
                      <realm-dashboard data-route="dashboard"></realm-dashboard>
                     </iron-pages>
  </template>

  <script>

    class RealmApp extends Polymer.mixinBehaviors([Polymer.LazyImportsBehavior], Polymer.Element) {

      static get is() {
        return 'realm-app';
      }

      static get properties() {
        return {
          session: {
            type: Object,
            value: null,
            observer: '_onSessionChanged'
          },
          page: {
            type: String,
            value: 'dashboard'
          }
        };
      }
      constructor() {
        super();
        window.performance && performance.mark && performance.mark('realm-app.created');
      }

      ready() {
        super.ready();
        this.removeAttribute('unresolved');
        this._ensureLazyLoaded();
      }
      _onSessionChanged(session) {
        if (!this.loadComplete) {
          return;
        }
        if (this.session && this.session.isAdmin) {
            this.page = 'dashboard';
        } else {
            this.page = 'web';
        }
        this.importLazyGroup(this.page);
      }
      _ensureLazyLoaded() {
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js');
              }
              this.importLazyGroup(this.page);
              this.loadComplete = true;
            });
          });
        }
      }
    }

    customElements.define(RealmApp.is, RealmApp);

  </script>

</dom-module>
